name: Build and test

on:
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  ui_jvm_tests:
    name: Jvm UI Compose tests
    runs-on: ubuntu-22.04
    env:
      isCI: "true"
      IN_MEMORY_DATABASE: 'true'
      DB_USER: 'user'
      WRITEOPIA_FIREBASE_ID: 'id'
      WRITEOPIA_CLIENT_BASE_URL: "baseurl"
    steps:
      - name: Check out code
        uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: adopt
          java-version: '17'
      - name: JVM tests
        run: ./gradlew jvmTest
      - name: upload results
        uses: actions/upload-artifact@v2  
        if: success() || failure()
        with:
          name: test-results-jvm
          path: ./application/desktopApp/build/reports/
  general_build:
    name: General - Build debug
    runs-on: ubuntu-22.04
    env:
      isCI: "true"
    steps:
      - name: Check out code
        uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: adopt
          java-version: '17'
      - name: Build debug 
        run: ./gradlew assembleDebug testDebug
  backend_build_and_test:
    name: Backend - build
    runs-on: ubuntu-22.04
    env:
      isCI: "true"
      IN_MEMORY_DATABASE: 'true'
      DB_USER: 'user'
      WRITEOPIA_FIREBASE_ID: 'id'
      WRITEOPIA_CLIENT_BASE_URL: "baseurl"
    steps:
      - name: Check out code
        uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: adopt
          java-version: '17'
      - name: Build backend
        run: ./gradlew backend:documents:documents_spring:assemble backend:editor:api_editor:assemble backend:editor:api_editor_spring:assemble :backend:editor:api_editor_spring:test
      - name: upload results
        uses: actions/upload-artifact@v2  
        if: success() || failure()
        with:
          name: test-results-backend
          path: ./backend/editor/api_editor_spring/build/reports/
  test_docusaurus:
    name: Test docusaurus
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: yarn
          cache-dependency-path: documentation/writeopia_docs/package-lock.json
      - name: Install dependencies
        working-directory: ./documentation/writeopia_docs
        run: yarn install --frozen-lockfile
      - name: Test build website
        working-directory: ./documentation/writeopia_docs
        run: yarn build
        